---
sidebar_position: 4
---

# Mailer Integration

In this document we are going to set up emailing service for the serverpod instance.

## Prerequisites

You should have:

- Already set up elbdesk_mailer service on a vps
- A domain name pointing to your mailer VPS instance and associated admin panel
- GitHub repository with GitHub Actions support and sufficient privileges to manipulate those (we are going to be covering this in this documentation)

## Introduction

In order for `elbdesk_server` to be able to register initial admin, new users, reset and validate passwords we need to connect our `elbdesk_server` instance to an already running `elbdesk_mailer` instance that handles emailing trough SMTP.

For our emailing to work our `elbdesk_server` project needs to be registered in our `elbdesk_mailer` admin service to get its unique `MAILER_API_TOKEN` and `MAILER_PROJECT_ID` which will be used to verify authenticity of the API calls that the `elbdesk_server` makes towards the `elbdesk_mailer` API endpoints.

We should register a unique `MAILER_API_TOKEN` and `MAILER_PROJECT_ID` for every `elbdesk_server` project we develop rather than reusing the API credentials for multiple `elbdesk_server` instances.
We do this in order to be able to revoke any credentials from a misbehaving `elbdesk_server` instance or in case of the mailer credentials leak without affecting the operation of other instances operating nominally.

## Registering a new mailer token

The mailer instance for `elbdesk_mailer` is hosted at https://mailer.elbdesk.com while its associated admin panel is hosted at https://mailer.elbdesk.com/admin.

First prerequisite for registering a new token actually generating one. For now that is a quite manual process but it boils down to just generating a Uuid.v4 string, converting it to bytes and encrypting it with sha256 algorithm using the key known to the admins. Store both the unencrypted uuid string token and the encrypted token, we will need it in later setup.

‚ö†Ô∏è **DO NOT USE ONLINE CRYPTO TOOLS FOR GENERATING THIS TOKEN!!!** ‚ö†Ô∏è

In order to register a new mailer token we need to log into the mailer_admin and create a new record in the `mailer_tokens` table and fill in the required information:

1. id - leave it empty as it will be autogenerated, this will be your `mailerProjectId`
2. name - name of the project and the branch separated by a dash [project-branch]
3. description - short description with the main mnemo information
4. api_token - Uuid.v4 string token converted to bytes then encrypted with sha256 using the proper key (contact admin)
5. client_contact_email - self explenatory
6. client_contact_phone - self explenatory
7. client_logo - small png image of the logo that will be used in the hero section of the email template

In the end we should end up with something like this:

![Mailer Admin - showing mailer_tokenss table](/img/mailer-admin-mailer-tokens.png)

## Adding a mailer token to `elbdesk_server`

In order for our service to work we need to add our unencrypted Uuid.v4 token and project id into the `elbdesk_server` `passwords.yaml` file. We need to do this for every run mode (development, staging, production). Make sure every run mode uses separate token and project id.

The final result should look something like:

```yaml
# configuration used, place it under `shared`.
#
# Note that this file should not be under version control. Store it in a safe
# place.

# Save passwords used across all configurations here.
shared:
  mailerHost: 'https://mailer.elbdesk.com'


# These are passwords used when running the server locally in development mode
development:
  mailerApiToken: 'ec7b4145-8b20-41f8-a31e-56e39a9b58d4'
  mailerProjectId: '6c66rd2t2g936e8'



# Passwords used in your staging environment if you use one. The default setup
# use a password for Redis.
staging:
  mailerApiToken: '20b6c889-f3fc-4bc8-b45b-6c66d22936e8'
  mailerProjectId: 'b56e39a9b58d4y5'



# Passwords used in production mode.
production:
  mailerApiToken: '546938e4-844b-4594-8992-f3b60e946c2b'
  mailerProjectId: '0r3r3b60e946f2k'
```

Optionally, if having a different mailer for any environment or run mode, the `mailerHost` can be moved from `shared:` into keys under `development`, `staging` and `production` individually.

## Final

That's it! The `elbdesk_server` project now has a working email service.

<center> üéâ </center>

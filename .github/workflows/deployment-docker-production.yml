name: Deploy to Production

on:
  # pull_request:
  #   branches: [production]
  #   types: [closed]
  workflow_dispatch:
    inputs:
      force_migration:
        description: "Force migration"
        required: true
        default: false
        type: boolean
      build_windows:
        description: "Build Windows MSIX"
        required: true
        default: false
        type: boolean
      version:
        description: "Version for the web app and Windows MSIX build (semver format: X.Y.Z[+build])"
        required: false
        type: string
      commit_ref:
        description: "Commit SHA or ref to build Windows MSIX from (leave empty for latest)"
        required: false
        type: string

run-name: Deploy to Production ${{ inputs.build_windows == true && format('(and build Windows MSIX v{0})', inputs.version) || '' }}

permissions:
  contents: write
  packages: write

jobs:
  call-deployment-docker-jobs:
    if: github.ref_name == 'production'
    # if: github.event.pull_request.merged == true
    uses: ./.github/workflows/deployment-docker-jobs.yml
    with:
      REGISTRY: "ghcr.io"
      GHCR_ORG: "app-ahoi"
      OWNER: "${{ github.repository_owner }}"
      IMAGE_NAME: ${{ github.repository }}
      FORCE_MIGRATION: ${{ inputs.force_migration }}
      WEB_APP_VERSION: ${{ inputs.version }}
      SERVERPOD_SERVERS: '[
        {
        "NAME": "coe_elbdesk_cloud",
        "PATH": "servers/elbdesk_server",
        "RUN_MODE": "production",
        "API_HOST": "api.coe.elbdesk.cloud",
        "INSIGHTS_HOST": "insights.coe.elbdesk.cloud",
        "WEB_HOST": "web.coe.elbdesk.cloud",
        "DATABASE_HOST": "coe_elbdesk_cloud-production-postgres-1",
        "REDIS_HOST": "redis.private-production.elbdesk.cloud",
        "DATABASE_NAME": "coe_production",
        "DATABASE_USER": "postgres_production",
        "DATABASE_PORT": "127.0.0.1:5432:5432",
        "FORCE_MIGRATION_LABEL": "needs-force-migrations",
        "SERVERPOD_VERSION": "2.9.1"
        }
        ]'
      FLUTTER_APPS: '[
        {
        "NAME": "coe_elbdesk_app",
        "PATH": "apps/elbdesk_app",
        "PACKAGES_PATH": "packages",
        "SERVERPOD_CLIENT_PATH": "servers/elbdesk_client",
        "RUN_MODE": "production",
        "APP_HOST": "coe.elbdesk.cloud",
        "API_HOST": "https://api.coe.elbdesk.cloud/",
        "FLUTTER_VERSION": "3.32.5"
        }
        ]'

    secrets:
      EMAIL: ${{ secrets.EMAIL }}
      DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD_PRODUCTION }}
      SERVERPOD_PASSWORDS: ${{ secrets.SERVERPOD_PASSWORDS }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      APP_ID: ${{ secrets.APP_ID }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}

  build-windows:
    if: inputs.build_windows == true && inputs.version != null && github.ref_name == 'production'
    uses: ./.github/workflows/build-windows-msix.yml
    with:
      version: ${{ inputs.version }}
      commit_ref: ${{ inputs.commit_ref }}
      OWNER: "${{ github.repository_owner }}"
    secrets:
      APP_ID: ${{ secrets.APP_ID }}
      APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
      PFX_BASE64: ${{ secrets.PFX_BASE64 }}
      PFX_PASSWORD: ${{ secrets.PFX_PASSWORD }}
      PACKAGES_SERVICE_AUTH: ${{ secrets.PACKAGES_SERVICE_AUTH }}
